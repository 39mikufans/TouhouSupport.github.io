var aidnlib,three,index,__extends=this&&this.__extends||function(){var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])})(t,e)};return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();!function(t){var r=(e.get=function(t){return this._data[t]},e.add=function(t,e){this._data[t]=e},e._data={},e);function e(){}t.Assets=r;var n=function(){};t.Ref=n;var i=(o.prototype.initialize=function(t){void 0===t&&(t=null),n.stw=aidn.window.width(),n.sth=aidn.window.height(),t&&0==t.isFit&&(this._isFit=!1),aidn.util.needExpandArea(!0),aidn.window.addDummyDiv()},o.prototype._start=function(){var t=this;n.time=Date.now()/1e3,aidn.window.resize(function(){return t._resize()},this._isFit),this._resize(),this._update()},o.prototype.addUpdate=function(t,e){t.__key||(t.__key="key_"+this.__keyCount,this.__keyCount++),this.__updates[t.__key]=e},o.prototype.removeUpdate=function(t){t.__key&&delete this.__updates[t.__key]},o.prototype.addResize=function(t,e){t.__key2||(t.__key2="key_"+this.__keyCount,this.__keyCount++),this.__resizes[t.__key2]=e},o.prototype.removeResize=function(t){t.__key2&&delete this.__resizes[t.__key2]},o.prototype._update=function(){var t,e=Date.now()/1e3;for(t in n.delta=e-n.time,n.time=e,this.__updates)this.__updates[t]()},o.prototype._resize=function(){for(var t in n.stw=aidn.window.width(),n.sth=aidn.window.height(),this.__resizes)this.__resizes[t]()},o);function o(){this.__keyCount=0,this.__updates={},this.__resizes={},this._isFit=!0}t.MainBase=i;var s=(a.prototype.start=function(){var e=this;aidn.util.checkMobile()?(window.addEventListener("deviceorientation",function(t){return e._deviceorientation(t)}),window.addEventListener("orientationchange",function(t){return e._orientationchange(t)},!1),this._orientationchange(),this._timeoutId=setTimeout(function(){return e._failedDeviceOrientation()},2e3),this._isAndroid=aidn.util.checkAndroid()):($("body").on("mousemove",function(t){return e._mouseMove(t)}),this._update())},a.prototype.addUpdate=function(t,e){t.__keyx||(t.__keyx="keyx_"+this.__keyCount,this.__keyCount++),this.__updates[t.__keyx]=e},a.prototype.removeUpdate=function(t){t.__keyx&&delete this.__updates[t.__keyx]},a.prototype._updateRate=function(t,e){for(var i in this.__updates)this.__updates[i](t,e)},a.prototype._mouseMove=function(t){var e=n.stw/2,i=n.sth/2,t=aidn.event.getPos(t);this._dx=(t.x-e)/e,this._dy=(t.y-i)/i},a.prototype._update=function(){var t=this;this._rx+=(this._dx-this._rx)/5,this._ry+=(this._dy-this._ry)/5,this._updateRate(this._rx,this._ry),window.requestAnimationFrame(function(){return t._update()})},a.prototype._deviceorientation=function(t){var e=t.gamma,i=t.beta;null!=this._timeoutId&&(clearTimeout(this._timeoutId),this._timeoutId=null),0!=this._ori&&(t=i,i=e,e=t,90==this._ori&&(i=-i),-90==this._ori&&(e=-e));e/=35,e=Math.max(e,-1);e=Math.min(e,1);i/=35,i=Math.max(i,-1);i=Math.min(i,1),this._updateRate(e,i)},a.prototype._devicemotion=function(t){var e=t.accelerationIncludingGravity||t.acceleration;this._ax<-100?(this._ax=e.x,this._ay=e.y):(this._ax+=(e.x-this._ax)/3,this._ay+=(e.y-this._ay)/3);var i=Math.floor(10*this._ax)/10,t=-Math.floor(10*this._ay)/10;this._isAndroid&&(i=-i,t=-t),0!=this._ori&&(e=t,t=i,i=e,90==this._ori&&(t=-t),-90==this._ori&&(i=-i));i/=5,i=Math.max(i,-1);i=Math.min(i,1);t/=5,t=Math.max(t,-1);t=Math.min(t,1),this._updateRate(i,t)},a.prototype._orientationchange=function(t){void 0===t&&(t=null),this._ori=parseInt(window.orientation.toString())||0,-1==this._ori&&(this._ori=0)},a.prototype._failedDeviceOrientation=function(){var e=this;window.addEventListener("devicemotion",function(t){return e._devicemotion(t)})},a);function a(){this._ori=0,this._dx=0,this._dy=0,this._rx=0,this._ry=0,this.__updates={},this.__keyCount=0,this._timeoutId=null,this._isAndroid=!1,this._ax=-1e3,this._ay=-1e3}t.DeviceManager=s;var u=(h.prototype.dispatchEvent=function(t){var e,i=t instanceof p?(e=t.type,t):new p(e=t);if(null!=this.listeners[e])for(var n=(i.currentTarget=this).listeners[e].length,o=0;o<n&&this.listeners[e];o++){var r=this.listeners[e][o];try{r.handler(i)}catch(t){window.console&&console.error(t.stack)}}},h.prototype.addEventListener=function(t,e,i){void 0===i&&(i=0),null==this.listeners[t]&&(this.listeners[t]=[]),this.listeners[t].push(new c(t,e,i)),this.listeners[t].sort(function(t,e){return e.priolity-t.priolity})},h.prototype.removeEventListener=function(t,e){if(this.hasEventListener(t,e))for(var i=0;i<this.listeners[t].length;i++){var n=this.listeners[t][i];if(n.equalCurrentListener(t,e))return n.handler=null,void this.listeners[t].splice(i,1)}},h.prototype.clearEventListener=function(){this.listeners={}},h.prototype.containEventListener=function(t){return null!=this.listeners[t]&&0<this.listeners[t].length},h.prototype.hasEventListener=function(t,e){if(null==this.listeners[t])return!1;for(var i=0;i<this.listeners[t].length;i++)if(this.listeners[t][i].equalCurrentListener(t,e))return!0;return!1},h);function h(){this.listeners={}}t.EventDispatcher=u;var c=(_.prototype.equalCurrentListener=function(t,e){return this.type==t&&this.handler==e},_);function _(t,e,i){void 0===e&&(e=null),void 0===i&&(i=0),this.type=t=void 0===t?null:t,this.handler=e,this.priolity=i}var p=function(t,e){void 0===e&&(e=null),this.type=t=void 0===t?null:t,this.data=e};t.Event=p;var d,i=(__extends(l,d=u),l.prototype.execute=function(){},l.prototype.cancel=function(){},l.prototype._dispatchComplete=function(t){void 0===t&&(t=null),this._loaded=!0;var e=new m(m.COMPLETE);e.data=t,this.dispatchEvent(e)},l.prototype._dispatchFailed=function(t){void 0===t&&(t=null);var e=new m(m.FAILED);e.data=t,this.dispatchEvent(e)},l.prototype._dispatchProgress=function(t){var e=new m(m.PROGRESS);e.progress=t,this.dispatchEvent(e)},l);function l(){var t=d.call(this)||this;return t._loaded=!1,t}t.CommandBase=i;var f,m=(__extends(y,f=p),y.COMPLETE="complete",y.FAILED="failed",y.PROGRESS="progress",y);function y(t){return f.call(this,t)||this}t.CommandEvent=m;var v,s=(__extends(b,v=i),b.prototype.execute=function(){if(this._loaded=!1,this._now=this._compnum=this._compRate=0,this._compflags=[],this._progRates=[],this._total<=this._compnum)return this._dispatchProgress(1),void this._dispatchComplete();for(var t=Math.min(this._total,this._connectionNum),e=0;e<t;e++)this._execute()},b.prototype.cancel=function(){if(!(this._total<=this._compnum))for(var t=0;t<this._total;t++)try{var e=this._commands[t];this._removeEvents(e),e.cancel()}catch(t){}},b.prototype.add=function(t,e){void 0===e&&(e=1),this._commands[this._total]=t,this._rates[this._total]=e,this._sum+=e,this._total++},b.prototype._execute=function(){var t,e=this;this._now<this._total?(this._rates[this._now]=this._rates[this._now]/this._sum,this._progRates[this._now]=0,(t=this._commands[this._now]).__id=this._now,this._now++,t.addEventListener(m.COMPLETE,function(t){return e._complete(t)}),t.addEventListener(m.PROGRESS,function(t){return e._progress(t)}),t.addEventListener(m.FAILED,function(t){return e._failed(t)}),t.execute()):this._total<=this._compnum&&(this._dispatchProgress(1),this._dispatchComplete())},b.prototype._removeEvents=function(t){t.clearEventListener()},b.prototype._completeCommand=function(t,e){},b.prototype._complete=function(t){var e=t.currentTarget.__id,t=this._commands[e];this._removeEvents(t),this._compRate+=this._rates[e],this._compflags[e]=!0,this.__progress(),this._completeCommand(t,e),this._compnum++,this._execute()},b.prototype._progress=function(t){var e=t.currentTarget.__id;this._progRates[e]=t.progress*this._rates[e],this.__progress()},b.prototype.__progress=function(){for(var t=0,e=0;e<this._now;e++)this._compflags[e]||(t+=this._progRates[e]);this._dispatchProgress(this._compRate+t)},b.prototype._failed=function(t){t=t.currentTarget.__id,t=this._commands[t];this._removeEvents(t),this._dispatchFailed()},Object.defineProperty(b.prototype,"loaded",{get:function(){return this._loaded},enumerable:!1,configurable:!0}),b);function b(t){void 0===t&&(t=1);var e=v.call(this)||this;return e._rates=[],e._sum=0,e._commands=[],e._now=0,e._total=0,e._compnum=0,e._compflags=[],e._connectionNum=t,e}t.SequentialCommand=s;var g,u=(__extends(w,g=i),w.prototype.execute=function(){function t(){i._complete()}function e(t){i._progress(t)}var i=this;this._audio=new aidn.AutoAudio(null),this._isplay?(this._audio.load([this._url],null,this._trimvol,e),this._audio.play(0,!1,t,0,0)):this._audio.load([this._url],t,this._trimvol,e)},w.prototype._progress=function(t){this._dispatchProgress(t)},w.prototype._complete=function(){this._isplay&&this._audio.stop();var t=(t=this._id)||this._url;r.add(t,this._audio),this._dispatchComplete()},w);function w(t,e,i,n){void 0===e&&(e=null),void 0===i&&(i=!1),void 0===n&&(n=-1);var o=g.call(this)||this;return o._id=e,o._url=t,o._isplay=i,o._trimvol=n,o}t.AudioLoadCommand=u;var x,u=(__extends(E,x=i),E.prototype.execute=function(){var i=this,n=new Image,o=this._name,t=this._type==j.PIXI?function(){var t=window.PIXI,e=new t.Texture(new t.BaseTexture(n));t.Texture.addTextureToCache(e,o),r.add(o,e),setTimeout(function(){i._complete()},10)}:this._type==j.THREE?function(){var t=new window.THREE.Texture(n);t.needsUpdate=!0,r.add(o,t),setTimeout(function(){i._complete()},10)}:function(){r.add(o,n),setTimeout(function(){i._complete()},10)};n.onload=t,n.src=this._url},E.prototype._complete=function(){this._dispatchComplete()},E);function E(t,e,i){void 0===e&&(e=null),void 0===i&&(i=-1);var n=x.call(this)||this;return n._url=t,n._type=i,(n._name=e)||(n._name=t),n}t.ImageLoadCommand=u;var R,s=(__extends(P,R=s),P);function P(t,e,i){void 0===i&&(i=-1);for(var n=R.call(this,e=void 0===e?1:e)||this,o=t.length,r=0;r<o;r++)n.add(new O(t[r],i));return n}t.ScriptsLoaderCommand=s;var T,O=(__extends(M,T=i),M.prototype.execute=function(){var t=this;$.ajax({url:this._url+"",cache:!0,dataType:"script"}).then(function(){return t._complete()},function(){return t._failed()})},M.prototype._complete=function(){this._dispatchComplete()},M.prototype._failed=function(){this._dispatchFailed()},M);function M(t,e){void 0===e&&(e=-1);var i=T.call(this)||this;return i._url=t,i._ver=e,i}t.ScriptLoaderCommand=O;var j=(C.PIXI=0,C.THREE=1,C.IMG=2,C);function C(){}t.JsonBase64Type=j;var H,i=(__extends(k,H=i),k.prototype.execute=function(){var e,t;this._json?this._complete(this._json):(t={method:"GET",url:(e=this)._url,dataType:"json",success:function(t){e._complete(t)},xhr:function(){var t=$.ajaxSettings.xhr();return t.onprogress=function(t){t.lengthComputable&&e._dispatchProgress(e._jsonRate*(t.loaded/t.total))},t}},$.ajax(t))},k.prototype._setupAudio=function(t){this._context=t},k.prototype._complete=function(t){var e,i=0;for(e in this._data=t)this._keys[i++]=e;this._now=-1,this._len=i,this._next()},k.prototype._next=function(){var i,n,t,o,e;this._now++,this._now<this._len?(this._dispatchProgress(this._jsonRate+(1-this._jsonRate)*(this._now/this._len)),n=(i=this)._keys[this._now],t=this._data[n],0<n.lastIndexOf(".mp3")||0<n.lastIndexOf(".ogg")?aidn.util.webaudio?(this._context&&(aidn.___waContext=this._context),e=new aidn.WebAudio,r.add(n,e),e.load(t,function(){i._next()})):setTimeout(function(){i._next()},10):(o=new Image,e=this._type==j.PIXI?function(){var t=window.PIXI,e=new t.Texture(new t.BaseTexture(o));t.Texture.addToCache?t.Texture.addToCache(e,n):t.Texture.addTextureToCache(e,n),r.add(n,e),setTimeout(function(){i._next()},10)}:this._type==j.THREE?function(){var t=new window.THREE.Texture(o);t.needsUpdate=!0,r.add(n,t),setTimeout(function(){i._next()},10)}:function(){r.add(n,o),setTimeout(function(){i._next()},10)},o.onload=e,o.src=t)):this._dispatchComplete()},k);function k(t,e,i){void 0===e&&(e=0),void 0===i&&(i=.3);var n=H.call(this)||this;return n._keys=[],n._context=null,n._json=null,"string"==typeof t?n._url=t:n._json=t,n._type=e,n._jsonRate=i,n}t.JsonBase64LoadCommand=i;I.prototype.set=function(t,e){return void 0===e&&(e=0),this.x=t=void 0===t?0:t,this.y=e,this},I.prototype.clone=function(){return new I(this.x,this.y)},I.prototype.distance=function(t){var e=this.x-t.x,t=this.y-t.y;return Math.sqrt(e*e+t*t)},i=I;function I(t,e){void 0===e&&(e=0),this.x=t=void 0===t?0:t,this.y=e}t.Point=i;L.random=function(t){var e=this.seed;return null!=(t=void 0===t?null:t)&&(e=t),e^=e<<13,e^=e>>17,(this.seed=e^=e<<15)/4294967296+.5},L.randInt=function(t,e,i){return void 0===i&&(i=null),Math.floor(this.rand(t,e+1,i))},L.rand=function(t,e,i){return this.random(i=void 0===i?null:i)*(e-t)+t},L.arrayShuffle=function(t){for(var e=t.length,i=0;i<e;i++){var n=this.randInt(0,e-1),o=t[i];t[i]=t[n],t[n]=o}},L.seed=0,i=L;function L(){}t.Util=i;Object.defineProperty(B,"bigIntSupported",{get:function(){return"undefined"!=typeof BigInt},enumerable:!1,configurable:!0}),B.toBaseN=function(t,e){if(0===t)return"0";for(var i=this.DIGITS,n=Math.min(i.length,e),o="";0<t;)o=i[t%n]+o,t=parseInt((t/n).toString(),10);return o},B.fromBaseN=function(t,e){if(null===t||0===t.length)return 0;for(var i=this.DIGITS,n=Math.min(i.length,e),o=0,r=0,s=t.length;r<s;r++){var a=i.indexOf(t[r]);if(a<0||e<=a)return NaN;o+=a*Math.pow(n,s-r-1)}return o},B.toBaseNBig=function(t,e){if(t===BigInt(0))return"0";for(var i=this.DIGITS,n=BigInt(Math.min(i.length,e)),o="";0<t;){o=i[parseInt((t%n).toString())]+o;t/=n}return o},B.fromBaseNBig=function(t,e){if(null===t||0===t.length)return BigInt(0);for(var i=this.DIGITS,n=BigInt(Math.min(i.length,e)),o=BigInt(0),r=0,s=t.length;r<s;r++){var a=i.indexOf(t[r]);if(a<0||e<=a)return null;for(var a=BigInt(a),u=BigInt(1),h=0;h<s-r-1;h++)u*=n;o+=a*u}return o},B.fromBaseNtoM=function(t,e,i){return this.toBaseN(this.fromBaseN(t,e),i)},B.fromBaseNtoMBig=function(t,e,i){return this.toBaseNBig(this.fromBaseNBig(t,e),i)},B.DIGITS="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",i=B;function B(){}t.NumUtil=i}(aidnlib=aidnlib||{}),function(t){var o,e=aidnlib.CommandBase,r=aidnlib.Assets,a=aidnlib.Ref,i=(__extends(n,o=e),n.prototype.execute=function(){var i=this;window.JSZipUtils.getBinaryContent(this._url,function(t,e){i._zipComplete(t,e)})},n.prototype._zipComplete=function(t,e){var i=this;window.JSZipUtils.loadAsync(e).then(function(t){i._binayComplete(t)})},n.prototype._binayComplete=function(t){var e,i=0;for(e in(this._zip=t).files)this._keys[i++]=e;this._now=-1,this._len=i,this._next()},n.prototype._next=function(){var e,i;this._now++,this._now<this._len?(this._dispatchProgress(this._now/this._len),i=(e=this)._keys[this._now],this._zip.file(i).async("arraybuffer").then(function(t){e._arrayComplete(t,i)})):this._dispatchComplete()},n.prototype._arrayComplete=function(t,e){var i,n,o=this;0<e.lastIndexOf(".vmd")&&(n=(i=this._loader).parser.parseVmd(t,!0),this._vs.push(n),t=this._mesh,t=i.animationBuilder.build(n,t),r.add("Motion"+this._n,t),r.add(e,t),this._n++),setTimeout(function(){return o._next()},10)},n);function n(t,e,i){var n=o.call(this)||this;return n._keys=[],n._n=0,n._vs=[],n._url=t,n._loader=e,n._mesh=i,n}t.ZipLoadCommand=i;var s,i=(__extends(u,s=e),u.prototype.execute=function(){var e=this;this._loader||(this._loader=r.get("loader")),this._mesh||(this._mesh=r.get("mesh"));var t=new XMLHttpRequest;(this._xhr=t).open("GET",this._url,!0),t.responseType="arraybuffer",t.onload=function(t){return e._loadComplete(t)},t.send()},u.prototype._loadComplete=function(t){var e=this._xhr.response,i=this._loader,n=i.parser.parseVmd(e,!0),e=this._mesh,e=i.animationBuilder.build(n,e);r.add(this._key,e),this._dispatchComplete()},u);function u(t,e,i,n){void 0===e&&(e="motion"),void 0===i&&(i=null),void 0===n&&(n=null);var o=s.call(this)||this;return o._url=t,o._loader=i,o._mesh=n,o._key=e,o}t.ThreeVmdLoadCommand=i;var h,i=(__extends(c,h=e),c.prototype.execute=function(){var e=this,t=new THREE.MMDLoader;r.add("loader",t),r.add(this._pmdUrl+"_loader",t),t.load(this._pmdUrl,function(t){e._complete(t)},function(t){e._progress(t)})},c.prototype._progress=function(t){t.lengthComputable&&(t=t.loaded/t.total,this._dispatchProgress(t))},c.prototype._complete=function(t){r.add(this._key,t),r.add(this._pmdUrl,t),this._dispatchComplete()},c);function c(t,e){void 0===e&&(e="mesh");var i=h.call(this)||this;return i._pmdUrl=t,i._key=e,i}t.ThreePmdLoadCommand=i;_.prototype.setPosVec=function(t,e){return this.setPos(t.x,t.y,t.z,e=void 0===e?1:e),this},_.prototype.setPos=function(t,e,i,n){return 1==(n=void 0===n?1:n)?(this.x=t,this.y=e,this.z=i):(this.x+=(t-this.x)*n,this.y+=(e-this.y)*n,this.z+=(i-this.z)*n),this},_.prototype.setRot=function(t,e,i){return this.rotationX=t,this.rotationY=e,this.rotationZ=i,this},_.prototype.getPos=function(){return this._target.position.clone()},_.prototype.getRot=function(){return this._target.rotation},_.prototype.get2D=function(t,e){void 0===e&&(e=null);var i=.5*a.stw,n=.5*a.sth,o=this._target.position.clone();return e&&o.add(e),o.project(t),o.x=Math.round((o.x+1)*i),o.y=Math.round((1-o.y)*n),new THREE.Vector2(o.x,o.y)},_.prototype.setQuaternion=function(t,e,i,n){1<(n=(n=void 0===n?1:n)<0?0:n)&&(n=1);var o=new THREE.Quaternion;return o.setFromEuler(new THREE.Euler(t,e,i,"XYZ")),this._target.quaternion.slerp(o,n),this},Object.defineProperty(_.prototype,"parent",{get:function(){return this._parent},enumerable:!1,configurable:!0}),Object.defineProperty(_.prototype,"target",{get:function(){return this._target},enumerable:!1,configurable:!0}),Object.defineProperty(_.prototype,"x",{get:function(){return this._target.position.x},set:function(t){this._target.position.x=t},enumerable:!1,configurable:!0}),Object.defineProperty(_.prototype,"y",{get:function(){return this._target.position.y},set:function(t){this._target.position.y=t},enumerable:!1,configurable:!0}),Object.defineProperty(_.prototype,"z",{get:function(){return this._target.position.z},set:function(t){this._target.position.z=t},enumerable:!1,configurable:!0}),Object.defineProperty(_.prototype,"rotationX",{get:function(){return this._target.rotation.x},set:function(t){this._target.rotation.x=t},enumerable:!1,configurable:!0}),Object.defineProperty(_.prototype,"rotationY",{get:function(){return this._target.rotation.y},set:function(t){this._target.rotation.y=t},enumerable:!1,configurable:!0}),Object.defineProperty(_.prototype,"rotationZ",{get:function(){return this._target.rotation.z},set:function(t){this._target.rotation.z=t},enumerable:!1,configurable:!0}),Object.defineProperty(_.prototype,"scale",{get:function(){return this._target.scale.x},set:function(t){t=this.__checkSc(t),this._target.scale.set(t,t,t)},enumerable:!1,configurable:!0}),Object.defineProperty(_.prototype,"scaleX",{get:function(){return this._target.scale.x},set:function(t){t=this.__checkSc(t),this._target.scale.x=t},enumerable:!1,configurable:!0}),Object.defineProperty(_.prototype,"scaleY",{get:function(){return this._target.scale.y},set:function(t){t=this.__checkSc(t),this._target.scale.y=t},enumerable:!1,configurable:!0}),Object.defineProperty(_.prototype,"scaleZ",{get:function(){return this._target.scale.z},set:function(t){t=this.__checkSc(t),this._target.scale.z=t},enumerable:!1,configurable:!0}),Object.defineProperty(_.prototype,"visible",{get:function(){return this._target.visible},set:function(t){this._target.visible=t},enumerable:!1,configurable:!0}),_.prototype.__checkSc=function(t){return t=0==t?.001:t},Object.defineProperty(_.prototype,"renderOrder",{get:function(){return this._target.renderOrder},set:function(t){this._target.renderOrder=t},enumerable:!1,configurable:!0}),e=_;function _(t,e){void 0===e&&(e=null),t=(t=void 0===t?null:t)||new THREE.Object3D,this._target=t,e?(this._parent=e,this._parent.add(this._target)):this._parent=t.parent}t.ThreeBase=e;var p=(Object.defineProperty(d.prototype,"bone",{get:function(){return this._bone},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"defRot",{get:function(){return this._defRot},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"defPos",{get:function(){return this._defPos},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"x",{get:function(){return this._bone.position.x},set:function(t){this._bone.position.x=t},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"y",{get:function(){return this._bone.position.y},set:function(t){this._bone.position.y=t},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"z",{get:function(){return this._bone.position.z},set:function(t){this._bone.position.z=t},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"rotationX",{get:function(){return this._bone.rotation.x},set:function(t){this._bone.rotation.x=t},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"rotationY",{get:function(){return this._bone.rotation.y},set:function(t){this._bone.rotation.y=t},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"rotationZ",{get:function(){return this._bone.rotation.z},set:function(t){this._bone.rotation.z=t},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"scale",{get:function(){return this._bone.scale.x},set:function(t){this._bone.scale.set(t,t,t)},enumerable:!1,configurable:!0}),d.prototype.add=function(){for(var t,e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];(t=this._bone).add.apply(t,e)},d.prototype.setRot=function(t,e,i){return this._bone.rotation.set(t,e,i),this},d.prototype.setQuaternion=function(t,e,i,n){1<(n=(n=void 0===n?1:n)<0?0:n)&&(n=1);i=(new THREE.Quaternion).setFromEuler(new THREE.Euler(t,e,i,"XYZ"));return this._bone.quaternion.slerp(i,n),this},d.prototype.setQuaternionFromEuler=function(t,e){1<(e=(e=void 0===e?1:e)<0?0:e)&&(e=1);t=(new THREE.Quaternion).setFromEuler(t);return this._bone.quaternion.slerp(t,e),this},d);function d(t){this._bone=t,this._defRot=t.rotation.clone(),this._defPos=t.position.clone()}t.BoneManager=p;var l,i=(__extends(f,l=e),Object.defineProperty(f.prototype,"mesh",{get:function(){return this._mesh},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"bones",{get:function(){return this._bones},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"acs",{get:function(){return this._acs},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"morphs",{get:function(){return this._mesh.morphTargetInfluences},enumerable:!1,configurable:!0}),f.prototype.logInfo=function(){var t=this._mesh;console.log("mesh.morphTargetDictionary:"),console.log(t.morphTargetDictionary),console.log("mesh.skeleton.bones:"),console.log(t.skeleton.bones)},f.prototype.initAnimation=function(t,e){void 0===e&&(e=-1);var i=new THREE.MMDAnimationHelper({sync:!1});i.enabled.physics=!1,this._helper=i,this._helper.add(this._mesh,{animation:t,physics:!1});t=this._helper.objects.get(this._helper.meshes[0]).mixer._actions;return this._acs=t,this.playAnimationId(e),t},f.prototype.playAnimationId=function(t){void 0===t&&(t=-1);for(var e=this._acs,i=0;i<e.length;i++)e[i].weight=i==t?1:0},f.prototype.update=function(){this._helper?this._helper.update(a.delta):this._ikSolver&&this._ikSolver.update()},f);function f(t,e,i,n){void 0===i&&(i=!1),void 0===n&&(n=!0);var o=l.call(this,t,e)||this;(o._mesh=t).geometry.userData&&t.geometry.userData.MMD&&n&&(o._ikSolver=new THREE.CCDIKSolver(t,t.geometry.userData.MMD.iks)),o._bones=[];for(var r=t.skeleton.bones.length,s=0;s<r;s++)o._bones[s]=new p(t.skeleton.bones[s]);for(var a,u=t.material,s=0;s<u.length;s++)i&&(a=u[s],(a=new THREE.MeshBasicMaterial({map:a.map,skinning:!0})).userData.outlineParameters=[],t.material[s]=a,t.material[s].needsUpdate=!0);return o}t.MMDManager=i;var m,i=(__extends(y,m=e),y.prototype.centerTrans=function(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this._geometry&&(this._geometry.applyMatrix?this._geometry.applyMatrix((new THREE.Matrix4).makeTranslation(t,e,i)):this._geometry.applyMatrix4((new THREE.Matrix4).makeTranslation(t,e,i)))},y.prototype.updateTexture=function(t,e){void 0===e&&(e=!1),this._material.map=t,this._material.needsUpdate=!0,this._map=this._material.map,this._material.blending=e?THREE.AdditiveBlending:THREE.NormalBlending},Object.defineProperty(y.prototype,"alpha",{get:function(){return this._material.opacity},set:function(t){this._material.opacity=t},enumerable:!1,configurable:!0}),Object.defineProperty(y.prototype,"mesh",{get:function(){return this._mesh},enumerable:!1,configurable:!0}),Object.defineProperty(y.prototype,"geometry",{get:function(){return this._geometry},enumerable:!1,configurable:!0}),Object.defineProperty(y.prototype,"material",{get:function(){return this._material},enumerable:!1,configurable:!0}),Object.defineProperty(y.prototype,"texture",{get:function(){return this._map},enumerable:!1,configurable:!0}),Object.defineProperty(y.prototype,"texOffsetX",{get:function(){return this._map.offset.x},set:function(t){this._map.offset.x=t},enumerable:!1,configurable:!0}),Object.defineProperty(y.prototype,"texOffsetY",{get:function(){return this._map.offset.y},set:function(t){this._map.offset.y=t},enumerable:!1,configurable:!0}),Object.defineProperty(y.prototype,"texRepeatX",{get:function(){return this._map.repeat.x},set:function(t){this._map.repeat.x=t},enumerable:!1,configurable:!0}),Object.defineProperty(y.prototype,"texRepeatY",{get:function(){return this._map.repeat.y},set:function(t){this._map.repeat.y=t},enumerable:!1,configurable:!0}),Object.defineProperty(y.prototype,"color",{get:function(){return this._color.getHex()},set:function(t){this._material.color.set(t)},enumerable:!1,configurable:!0}),y);function y(t,e){e=m.call(this,t,e=void 0===e?null:e)||this;if(t.geometry)try{e._mesh=t}catch(t){}return t.geometry&&(e._geometry=t.geometry),t.material&&(e._material=t.material,e._map=e._material.map,e._color=e._material.color),e}t.PrimBase=i;var v,e=(__extends(b,v=i),Object.defineProperty(b.prototype,"sprite",{get:function(){return this._sprite},enumerable:!1,configurable:!0}),Object.defineProperty(b.prototype,"material",{get:function(){return this._sprite.material},enumerable:!1,configurable:!0}),Object.defineProperty(b.prototype,"rotation",{get:function(){return this._sprite.material.rotation},set:function(t){this._sprite.material.rotation=t},enumerable:!1,configurable:!0}),b);function b(t,e){var i=this,e=new THREE.Sprite(e);return(i=v.call(this,e,t)||this)._sprite=e,i}t.PrimSprite=e;var g,e=(__extends(w,g=i),Object.defineProperty(w.prototype,"line",{get:function(){return this._line},enumerable:!1,configurable:!0}),Object.defineProperty(w.prototype,"material",{get:function(){return this._line.material},enumerable:!1,configurable:!0}),w);function w(t,e,i,n){void 0===e&&(e=null),void 0===i&&(i=-1),void 0===n&&(n=1);var o,r=this,s=new THREE.Geometry;return s.vertices=t,0<=i?(o=new THREE.LineBasicMaterial({color:i,linewidth:n,linecap:"square",linejoin:"miter",transparent:!0}),o=new THREE.Line(s,o)):(o=new THREE.Line(s)).visible=!1,(r=g.call(this,o,e)||this)._line=o,r}t.PrimLine=e;var x,e=(__extends(E,x=i),E);function E(t,e,i,n,o,r){void 0===i&&(i=1),void 0===n&&(n=1),void 0===o&&(o=1),void 0===r&&(r=1);var s=this,r=new THREE.PlaneGeometry(i,n,o,r),e=new THREE.Mesh(r,e);return(s=x.call(this,e,t)||this)._mesh=e,s}t.PrimPlane=e;var R,e=(__extends(P,R=i),P);function P(t,e,i,n,o,r,s,a){void 0===r&&(r=1),void 0===s&&(s=1),void 0===a&&(a=1);var u=this,a=new THREE.BoxGeometry(i,n,o,r,s,a),e=new THREE.Mesh(a,e);return(u=R.call(this,e,t)||this)._mesh=e,u}t.PrimCube=e;var T,e=(__extends(O,T=i),O);function O(t,e,i,n,o){void 0===n&&(n=8),void 0===o&&(o=6);var r=this,o=new THREE.SphereGeometry(i,n,o),e=new THREE.Mesh(o,e);return(r=T.call(this,e,t)||this)._mesh=e,r}t.PrimSphere=e;var M,e=(__extends(j,M=i),j);function j(t,e,i,n,o,r,s,a){void 0===r&&(r=8),void 0===s&&(s=1),void 0===a&&(a=!1);var u=this,a=new THREE.CylinderGeometry(i,n,o,r,s,a),e=new THREE.Mesh(a,e);return(u=M.call(this,e,t)||this)._mesh=e,u}t.PrimCylinder=e;var C,e=(__extends(H,C=i),H);function H(t,e,i,n,o,r){void 0===o&&(o=8),void 0===r&&(r=1);var s=this,r=new THREE.RingGeometry(i,n,o,r),e=new THREE.Mesh(r,e);return(s=C.call(this,e,t)||this)._mesh=e,s}t.PrimRing=e;var k,i=(__extends(I,k=i),I);function I(t,e,i,n,o,r){void 0===n&&(n=2),void 0===o&&(o=8),void 0===r&&(r=8);var s=this,o=new THREE.TorusGeometry(i,n,r,o),e=new THREE.Mesh(o,e);return(s=k.call(this,e,t)||this)._mesh=e,s}t.PrimTorus=i;L.from2Dto3D=function(t){var e=t.camera,i=t.x,n=t.y,o=isNaN(t.z)?1:t.z,r=a.stw,s=a.sth,r=i/(r=0<t.width?t.width:r)*2-1,s=-n/(s=0<t.height?t.height:s)*2+1,o=new THREE.Vector3(0,0,o);o.project(e);o=new THREE.Vector3(r,s,o.z);return o.unproject(e),o},L.from3Dto2D=function(t){var e=a.stw,i=a.sth,n=.5*(e=0<t.width?t.width:e),e=.5*(i=0<t.height?t.height:i),i=t.pos.clone();return i.project(t.camera),i.x=Math.round((i.x+1)*n),i.y=Math.round((1-i.y)*e),{x:i.x,y:i.y}},i=L;function L(){}t.ThreeUtil=i}(three=three||{}),function(t){var u=aidn.math,i=aidnlib.Ref,e=aidnlib.MainBase,h=aidnlib.Assets,n=aidnlib.DeviceManager,o=aidnlib.JsonBase64LoadCommand,r=aidnlib.JsonBase64Type,s=aidnlib.SequentialCommand,a=aidnlib.CommandEvent,c=three.ThreeBase;function _(){(p.main||new v).initialize()}t.check=function(){$(function(){p.main||new v}),function t(){"undefined"==typeof THREE?setTimeout(function(){return t()},10):$(_)}()};var p=(d.enableDevice=!1,d);function d(){}var l,f=(__extends(m,l=s),m);function m(){var t=l.call(this,1)||this;t.add(new aidnlib.ScriptsLoaderCommand(["shared/main/js/lib.js"])),t.add(new o("shared/main/img/miku/tex.json",r.THREE));var e="shared/main/img/miku/box_miku.pmd";return 0<=navigator.userAgent.indexOf("Firefox")&&(e="shared/main/img/mikuu_ff/box_miku.pmd"),t.add(new three.ThreePmdLoadCommand(e)),t}var y,v=(__extends(b,y=e),b.prototype.initialize=function(){var t=this;y.prototype.initialize.call(this),$("#menu").show();var e=new f;e.addEventListener(a.COMPLETE,function(){return t._initComplete()}),e.execute()},b.prototype._initComplete=function(){var t=this;this._three=new H,this._start(),$("#view").stop().delay(200).animate({opacity:.5},700,"linear"),setTimeout(function(){return t.__showView()},2e3),setTimeout(function(){return t.__showView()},4e3)},b.prototype.__showView=function(){$("#view").animate({opacity:.5},700,"linear")},b.prototype._clickGyro=function(t){t.preventDefault(),aidn.util.deviceMotionRequestPermission()},b.prototype._start=function(){y.prototype._start.call(this)},b.prototype._update=function(){var t=this;y.prototype._update.call(this),window.requestAnimFrame(function(){return t._update()})},b.prototype._resize=function(){y.prototype._resize.call(this),$("#menu").show(),$("#menu").css("display","block")},b);function b(){var e=y.call(this)||this;return p.main=e,p.isMobile=aidn.util.checkMobile(),p.isMobile&&$(".nico").attr("href","http://sp.nicovideo.jp/mylist/4009728?sort=8"),aidn.util.checkJapanese()||$(".nico").hide(),$("#menu").stop().show(),$("#loading").hide(),p.device=new n,p.device.start(),$("#gyro").on("click",function(t){return e._clickGyro(t)}),e}Object.defineProperty(g.prototype,"pass",{get:function(){return this._pass},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"enabled",{get:function(){return this._pass.enabled},set:function(t){this._pass.enabled=t},enumerable:!1,configurable:!0}),Object.defineProperty(g.prototype,"renderToScreen",{get:function(){return this._pass.renderToScreen},set:function(t){this._pass.renderToScreen=t},enumerable:!1,configurable:!0}),g.prototype.start=function(t){var e=this;void 0===t&&(t=120),this.enabled=!0,0<t&&(clearTimeout(this.__timeoutId),this.__timeoutId=setTimeout(function(){return e.__complete()},t))},g.prototype.__complete=function(){this.enabled=!1},e=g;function g(t){this.__timeoutId=-1,t.enabled=!1,this._pass=t}var w,x=(__extends(E,w=e),Object.defineProperty(E.prototype,"uniforms",{get:function(){return this._epass.uniforms},enumerable:!1,configurable:!0}),E.prototype.start=function(t){w.prototype.start.call(this,t=void 0===t?120:t)},E);function E(){var t=this,e=.6;p.isMobile&&(e=.8);e=new THREE.DotScreenPass(new THREE.Vector2(0,0),.5,e);return(t=w.call(this,e)||this)._epass=e,t}var R=(P.prototype._init=function(){this._efDotSc=new x,this._efDotSc.start(-1),this._effects=[this._efDotSc],this._total=this._effects.length},P.prototype.setSize=function(t,e){this._renderer.setSize(t,e),this._comp.setSize(t,e)},P.prototype.render=function(){for(var t=this._total,e=[this._pass],i=1,n=0;n<t;n++)this._effects[n].enabled&&(e[i]=this._effects[n].pass,i++);if(1<i){for(n=0;n<i;n++)e[n].renderToScreen=n==i-1;this._comp.passes=e,this._comp.render()}else this._renderer.render(this._scene,this._camera)},P);function P(t,e,i){this._effects=[],this._total=0;var n=new THREE.RenderPass(i,e),o=new THREE.EffectComposer(t);this._renderer=t,this._camera=e,this._scene=i,this._comp=o,this._pass=n,this._init()}var T=(Object.defineProperty(O.prototype,"defRot",{get:function(){return this._defRot},enumerable:!1,configurable:!0}),Object.defineProperty(O.prototype,"defPos",{get:function(){return this._defPos},enumerable:!1,configurable:!0}),Object.defineProperty(O.prototype,"x",{get:function(){return this._bone.position.x},set:function(t){this._bone.position.x=t},enumerable:!1,configurable:!0}),Object.defineProperty(O.prototype,"y",{get:function(){return this._bone.position.y},set:function(t){this._bone.position.y=t},enumerable:!1,configurable:!0}),Object.defineProperty(O.prototype,"z",{get:function(){return this._bone.position.z},set:function(t){this._bone.position.z=t},enumerable:!1,configurable:!0}),Object.defineProperty(O.prototype,"rotX",{get:function(){return this._bone.rotation.x},set:function(t){this._bone.rotation.x=t},enumerable:!1,configurable:!0}),Object.defineProperty(O.prototype,"rotY",{get:function(){return this._bone.rotation.y},set:function(t){this._bone.rotation.y=t},enumerable:!1,configurable:!0}),Object.defineProperty(O.prototype,"rotZ",{get:function(){return this._bone.rotation.z},set:function(t){this._bone.rotation.z=t},enumerable:!1,configurable:!0}),Object.defineProperty(O.prototype,"scale",{get:function(){return this._bone.scale.x},set:function(t){this._bone.scale.set(t,t,t)},enumerable:!1,configurable:!0}),O.CENTER=0,O.UPPER_BODY=2,O.NECK=3,O.HEAD=4,O.L_SHOULDER=6,O.L_ARM=7,O.L_ELBOW=8,O.R_SHOULDER=11,O.R_ARM=12,O.R_ELBOW=13,O.LOWER_BODY=16,O.L_HAIR1=26,O.R_HAIR1=27,O.L_HAIR2=28,O.R_HAIR2=29,O.L_HAIR3=30,O.R_HAIR3=31,O);function O(t){this._bone=t,this._defRot=t.rotation.clone(),this._defPos=t.position.clone()}var M,j=(__extends(C,M=c),Object.defineProperty(C.prototype,"mesh",{get:function(){return this._mesh},enumerable:!1,configurable:!0}),C.prototype._deviceUpdate=function(t,e){p.enableDevice=!0,p.isMobile&&(e-=.2,t*=1.4),this._poseUpdate(t,e)},C.prototype._poseUpdate=function(t,e){this._bones[T.UPPER_BODY].rotX=u.toRad(30*e-15),this._bones[T.UPPER_BODY].rotZ=-u.toRad(20*t),this._bones[T.NECK].rotZ=-u.toRad(20*t),this._bones[T.L_HAIR1].rotZ=-u.toRad(20*e-20),this._bones[T.R_HAIR1].rotZ=u.toRad(20*e-20),this._bones[T.L_HAIR2].rotZ=-u.toRad(30*e-30),this._bones[T.R_HAIR2].rotZ=u.toRad(30*e-30),this._bones[T.L_ARM].rotZ=-u.toRad(50*e-20),this._bones[T.R_ARM].rotZ=u.toRad(50*e-20),this._bones[T.L_ELBOW].rotZ=-u.toRad(10+30*e),this._bones[T.R_ELBOW].rotZ=u.toRad(10+30*e)},C.prototype.update=function(){var t,e;this._mesh.rotation.y+=.85*i.delta,p.enableDevice||(t=.8*Math.sin(1.23*i.time),e=.8*Math.cos(1.41*i.time),this._poseUpdate(t,e))},C);function C(t){var i=this,e=h.get("mesh");e.castShadow=!0,(i=M.call(this,e,t)||this)._mesh=e,i._bones=[];for(var n=e.skeleton.bones.length,o=0;o<n;o++)i._bones[o]=new T(e.skeleton.bones[o]);for(var r=e.material,o=0;o<r.length;o++){var s=r[o];s.shininess=0,s.userData.outlineParameters={};var a=new THREE.MeshBasicMaterial({map:s.map,skinning:!0});a.userData.outlineParameters=[],a.needsUpdate=!0,e.material[o]=a,s.needsUpdate=!0}t=new THREE.MMDAnimationHelper({sync:!1});return t.enabled.physics=!1,i._helper=t,i._bones[T.L_ARM].rotZ=-u.toRad(30),i._bones[T.R_ARM].rotZ=u.toRad(30),--i._bones[T.L_HAIR2].y,--i._bones[T.R_HAIR2].y,i._mesh.rotation.y=-u.toDeg(60),p.device.addUpdate(i,function(t,e){return i._deviceUpdate(t,e)}),i}var H=(k.prototype._deviceUpdate=function(t,e){this.__showedGyro&&($("#gyro").stop().fadeOut(300),this.__showedGyro=!1),p.enableDevice=!0,this._updatePosition(t,e)},k.prototype._updatePosition=function(t,e){this._camera.position.y=+e+5,this._camera.position.z=16+6*e,this._camera.position.x=+t+0},k.prototype._update=function(){var t,e;this._model.update(),this._box.rotationY=this._model.mesh.rotation.y,p.enableDevice||(this.__showedGyro||($("#gyro").stop().fadeIn(300),this.__showedGyro=!0),t=.8*Math.sin(1.33*i.time),e=.8*Math.cos(1.11*i.time),this._updatePosition(t,e)),this._effeMng.render()},k.prototype._resize=function(){var t=i.stw,e=i.sth;this._camera.fov=30+e/t*10,this._camera.aspect=t/e,this._camera.updateProjectionMatrix(),this._effeMng.setSize(t,e),this._effeMng.render()},k);function k(){var i=this;this.__showedGyro=!1;var t=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,.05,400);t.position.z=20,t.position.y=6;var e=new THREE.Scene;e.background=new THREE.Color(16777215);var n=Math.min(window.devicePixelRatio,2),o=document.getElementById("view"),r=this._renderer=new THREE.WebGLRenderer({antialias:!0});r.setPixelRatio(n),r.setSize(window.innerWidth,window.innerHeight),o.appendChild(r.domElement),this._renderer=r,this._scene=e,this._camera=t,this._model=new j(e),this._effeMng=new R(r,t,e),p.main.addUpdate(this,function(){return i._update()}),p.main.addResize(this,function(){return i._resize()});e=new THREE.MeshBasicMaterial({color:13421772}),e=new three.PrimCube(this._scene,e,1,1,1);e.scale=7,e.y=0-e.scaleY/2,this._box=e,p.device.addUpdate(this,function(t,e){return i._deviceUpdate(t,e)})}}(index=index||{}),index.check();